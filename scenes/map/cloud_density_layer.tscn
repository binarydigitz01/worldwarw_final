[gd_scene load_steps=5 format=3 uid="uid://ctr3rkg7fx5eq"]

[ext_resource type="Texture2D" uid="uid://bee5k8gk0gaog" path="res://assets/pictures/cloud.png" id="1_56m17"]

[sub_resource type="TileSetAtlasSource" id="TileSetAtlasSource_u6nch"]
texture = ExtResource("1_56m17")
texture_region_size = Vector2i(64, 64)
1:0/0 = 0
2:0/0 = 0
0:0/0 = 0
3:0/0 = 0

[sub_resource type="TileSet" id="TileSet_stett"]
tile_shape = 3
tile_layout = 5
tile_offset_axis = 1
tile_size = Vector2i(64, 32)
custom_data_layer_0/name = "cloud_density"
custom_data_layer_0/type = 3
sources/0 = SubResource("TileSetAtlasSource_u6nch")

[sub_resource type="GDScript" id="GDScript_ac7yy"]
script/source = "extends TileMapLayer

func _on_day_cycle_timer_timeout() -> void:
	var ground_water = Global.ground_water
	var threshold=10
	var is_raining = (randi_range(0,100)+33)<ground_water
	var cells = get_used_cells()
	for c in cells:
		var data = get_cell_tile_data(c)
		var this_cloud_density = data.get_custom_data(\"cloud_density\")
		var avg_cells=get_surrounding_cells(c)
		var cloud_density_change: float = 0
		for nc in avg_cells:
			cloud_density_change += nc*ground_water/100
		data.set_custom_data(\"cloud_density\",this_cloud_density+cloud_density_change)
		if get_cell_atlas_coords(c).x==3 and is_raining:
			data.set_custom_data(\"cloud_density\",this_cloud_density/100)
		elif this_cloud_density>threshold*get_cell_atlas_coords(c):
			set_cell(c,0,Vector2i((get_cell_atlas_coords(c).x+1)%3,0))


func _on_day_cycle_timeout() -> void:
	pass # Replace with function body.
"

[node name="CloudDensityLayer" type="TileMapLayer"]
z_index = 5
tile_set = SubResource("TileSet_stett")
script = SubResource("GDScript_ac7yy")

[node name="day_cycle" type="Timer" parent="."]
autostart = true

[connection signal="timeout" from="day_cycle" to="." method="_on_day_cycle_timeout"]
